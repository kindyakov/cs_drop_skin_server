generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

enum PaymentProvider {
  EXNODE
  YOOKASSA
}

enum ItemRarity {
  CONSUMER
  INDUSTRIAL
  MIL_SPEC
  RESTRICTED
  CLASSIFIED
  COVERT
  KNIFE
}

enum ItemStatus {
  OWNED
  WITHDRAWN
  SOLD
}

model User {
  id        String   @id @default(cuid())
  steamId   String?  @unique
  vkId      String?  @unique
  username  String
  avatarUrl String?
  balance   Int      @default(0)
  role      UserRole @default(USER)
  isBlocked Boolean  @default(false)
  
  // Profile fields
  tradeUrl        String?  // Steam trade URL
  favoriteCaseId  String?  // ID самого часто открываемого кейса
  bestDropItemId  String?  // ID самого дорогого выбитого предмета
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items        UserItem[]
  openings     CaseOpening[]
  transactions Transaction[]
  
  favoriteCase Case? @relation("UserFavoriteCase", fields: [favoriteCaseId], references: [id], onDelete: SetNull)
  bestDrop     Item? @relation("UserBestDrop", fields: [bestDropItemId], references: [id], onDelete: SetNull)

  @@index([steamId])
  @@index([vkId])
  @@index([role])
  @@index([isBlocked])
  @@index([favoriteCaseId])
  @@index([bestDropItemId])
  @@map("users")
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  imageUrl    String?
  order       Int      @default(0) // Порядок сортировки
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Связи
  cases       Case[]

  @@index([slug])
  @@index([isActive])
  @@index([order])
  @@map("categories")
}

model Case {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  imageUrl    String
  price       Decimal  @db.Decimal(10, 2)
  isActive    Boolean  @default(true)

  // Механика открытий кейса
  maxOpenings    Int     @default(100)    // Конфигурация для расчета вероятностей
  openingsCount  Int     @default(0)      // Счётчик фактических открытий (для метрик)

  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  items       CaseItem[]
  openings    CaseOpening[]
  favoritedBy User[]   @relation("UserFavoriteCase")

  @@index([slug])
  @@index([isActive])
  @@index([categoryId])
  @@map("cases")
}

model Item {
  id             String     @id @default(cuid())
  marketHashName String  @unique
  displayName    String
  weaponName     String?
  skinName       String?
  categoryName   String?
  quality        String?
  imageUrl       String
  price          Decimal    @db.Decimal(10, 2)
  rarity         ItemRarity
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  caseItems   CaseItem[]
  userItems   UserItem[]
  openings    CaseOpening[]
  bestDropFor User[] @relation("UserBestDrop")

  @@index([marketHashName])
  @@index([rarity])
  @@map("items")
}

model CaseItem {
  id           String   @id @default(cuid())
  caseId       String
  itemId       String
  chancePercent Decimal @db.Decimal(5, 2)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)
  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([caseId, itemId])
  @@index([caseId])
  @@index([itemId])
  @@map("case_items")
}

model UserItem {
  id         String     @id @default(cuid())
  userId     String
  itemId     String
  acquiredAt DateTime   @default(now())
  status     ItemStatus @default(OWNED)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([itemId])
  @@index([status])
  @@map("user_items")
}

model CaseOpening {
  id       String   @id @default(cuid())
  userId   String
  caseId   String
  itemId   String
  openedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)
  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([caseId])
  @@index([openedAt])
  @@map("case_openings")
}

model Transaction {
  id           String            @id @default(cuid())
  userId       String
  amount       Int
  type         TransactionType
  status       TransactionStatus @default(PENDING)
  paymentId    String?           @unique
  provider     PaymentProvider   @default(EXNODE)
  trackerId    String?           @unique
  cryptoAmount Decimal?          @db.Decimal(18, 8)
  fiatCurrency String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([paymentId])
  @@index([trackerId])
  @@index([createdAt])
  @@map("transactions")
}

model Settings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("settings")
}